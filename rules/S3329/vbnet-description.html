<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When encrypting data with the Cipher Block Chaining (CBC) mode an Initialization Vector (IV) is used to randomize the encryption, ie under a given key the same plaintext doesn&#8217;t always produce the same ciphertext. The IV doesn&#8217;t need to be secret but should be unpredictable to avoid  "Chosen-Plaintext Attack".</p>
</div>
<div class="paragraph">
<p>To generate Initialization Vectors, NIST recommends to use a secure random number generator.</p>
</div>
<div class="sect2">
<h3 id="_noncompliant_code_example">Noncompliant code example</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-vbnet" data-lang="vbnet">Public Sub Encrypt(Key() As Byte, Data() As Byte, Target As MemoryStream)
    Dim InitializationVector As Byte() = {1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16}
    Using Aes As New AesCryptoServiceProvider()
        Dim Encryptor As ICryptoTransform = Aes.CreateEncryptor(Key, InitializationVector)  ' Noncompliant, hardcoded value Is used
        Using CS As New CryptoStream(Target, Encryptor, CryptoStreamMode.Write)
            CS.Write(Data)
        End Using
    End Using
End Sub</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_compliant_solution">Compliant solution</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-vbnet" data-lang="vbnet">Public Sub Encrypt(Key() As Byte, Data() As Byte, Target As MemoryStream)
    Using Aes As New AesCryptoServiceProvider()
        Aes.GenerateIV()
        Dim Encryptor As ICryptoTransform = Aes.CreateEncryptor(Key, Aes.IV)
        Using CS As New CryptoStream(Target, Encryptor, CryptoStreamMode.Write)
            CS.Write(Data)
        End Using
    End Using
End Sub</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://owasp.org/Top10/A02_2021-Cryptographic_Failures/">OWASP Top 10 2021 Category A2</a> - Cryptographic Failures</p>
</li>
<li>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A3-Sensitive_Data_Exposure">OWASP Top 10 2017 Category A3</a> - Sensitive Data Exposure</p>
</li>
<li>
<p><a href="https://mobile-security.gitbook.io/masvs/security-requirements/0x08-v3-cryptography_verification_requirements">Mobile AppSec Verification Standard</a> - Cryptography Requirements</p>
</li>
<li>
<p><a href="https://owasp.org/www-project-mobile-top-10/2016-risks/m5-insufficient-cryptography">OWASP Mobile Top 10 2016 Category M5</a> - Insufficient Cryptography</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/329">MITRE, CWE-329</a> - Not Using an Unpredictable IV with CBC Mode</p>
</li>
<li>
<p><a href="https://nvlpubs.nist.gov/nistpubs/Legacy/SP/nistspecialpublication800-38a.pdf">NIST, SP-800-38A</a> - Recommendation for Block  Cipher Modes of Operation</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Use a dynamically-generated, random IV.</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_is_duplicated_by_s3275">is duplicated by: <a data-rspec-id="S3275" class="rspec-auto-link">S3275</a></h3>

</div>
<div class="sect2">
<h3 id="_relates_to_s4787">relates to: <a data-rspec-id="S4787" class="rspec-auto-link">S4787</a></h3>

</div>
<div class="sect2">
<h3 id="_is_related_to_s2245">is related to: <a data-rspec-id="S2245" class="rspec-auto-link">S2245</a></h3>

</div>
<div class="sect2">
<h3 id="_on_22_oct_2020_095327_alexandre_gigleux_wrote">on 22 Oct 2020, 09:53:27 Alexandre Gigleux wrote:</h3>
<div class="paragraph">
<p>\[~pierre-loup.tristant] For C#, we could use the 17 test cases produced by the SARD (https://samate.nist.gov/SARD/testsuite.php &gt; Juliet Test Suite for C#). It&#8217;s inside the directory CWE329_Not_Using_Random_IV_with_CBC_Mode.</p>
</div>
</div>
</div>
</div>